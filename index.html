<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Escape Grid</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <link href="https://fonts.googleapis.com/css2?family=Comic+Relief&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div id="game-container">
      <h2 id="team-name">Amazing race</h2>
      <div class="grid-wrapper">
        <img class="background-image" src="./assets/final.png" alt="Hidden image" />
        <div class="grid" id="grid"></div>
      </div>
      <img class="bottomImg" src="./assets/bottom.png" alt="minionssssssss" />
      <div id="final-reveal">ðŸŽ‰ All tiles revealed! ðŸŽ‰</div>
    </div>

    <!-- Wordle Modal -->
    <div id="wordle-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeWordleModal()">&times;</button>
        <h2>Game 1: Wordle</h2>
        <div class="wordle-board" id="wordle-board"></div>
        <div class="keyboard" id="keyboard"></div>
        <div class="wordle-message" id="wordle-message"></div>
      </div>
    </div>

    <!-- Emoji Guessing Modal -->
    <div id="emoji-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeEmojiModal()">&times;</button>
        <h2>Game 2: Guess the Emoji</h2>
        <div class="emoji-game">
          <div class="emoji-display" id="emoji-display"></div>
          <input
            type="text"
            id="emoji-input"
            class="input"
            placeholder="Type your answer..."
          />
          <button class="emoji-submit" onclick="submitEmojiGuess()">
            Submit
          </button>
          <div class="emoji-message" id="emoji-message"></div>
          <div class="emoji-progress" id="emoji-progress">Question 1 of 5</div>
        </div>
      </div>
    </div>

    <!-- Amazing Race Question Modal -->
    <div id="qa-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeQAModal()">&times;</button>
        <h2 id="qa-title"></h2>
        <div class="question-game">
          <p id="qa-question" class="white-space-preline"></p>
          <input
            type="text"
            id="qa-input"
            class="input"
            placeholder="Type your answer..."
          />
          <button class="emoji-submit" onclick="submitQAAnswer()">
            Submit
          </button>
          <div class="emoji-message" id="qa-message"></div>
        </div>
      </div>
    </div>

    <!-- Rebus Puzzle Modal -->
    <div id="rebus-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeRebusModal()">&times;</button>
        <h2>Game 3: Rebus Puzzle</h2>
        <div class="rebus-game">
          <img id="rebus-image" src="" alt="Rebus Puzzle" style="width:100%; max-width:500px; margin-bottom:20px;" />
          <input
            type="text"
            id="rebus-input"
            class="input"
            placeholder="Type your answer..."
          />
          <button class="emoji-submit" onclick="submitRebusGuess()">Submit</button>
          <div class="emoji-message" id="rebus-message"></div>
          <div class="emoji-progress" id="rebus-progress">Question 1 of 5</div>
        </div>
      </div>
    </div>

    <!-- Notice Modal -->
    <div id="notice-modal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeNoticeModal()">&times;</button>
        <h2>Notice</h2>
        <p id="notice-message"></p>
      </div>
    </div>

    <script>
      // SessionStorage functions (clears when tab/browser closes)
      function saveGameState() {
        const revealedTiles = Array.from(
          document.querySelectorAll(".tile.revealed")
        ).map((tile) => parseInt(tile.getAttribute("data-tile-index")));

        sessionStorage.setItem(
          "escapeGridRevealed",
          JSON.stringify(revealedTiles)
        );
        console.log("ðŸ’¾ Game saved! Data will clear when you close the tab.");
      }

      function loadGameState() {
        const saved = sessionStorage.getItem("escapeGridRevealed");
        if (!saved) {
          console.log("ðŸŽ® Starting fresh game session!");
          return [];
        }

        try {
          const tiles = JSON.parse(saved);
          console.log("âœ… Game progress restored!");
          return tiles;
        } catch (e) {
          console.error("Error loading game state:", e);
          return [];
        }
      }

      function isTileRevealed(tileIndex) {
        const revealed = loadGameState();
        return revealed.includes(tileIndex);
      }

      // Cache for validated words to avoid repeated API calls
      window.onload = () => {
        const grid = document.getElementById("grid");

        // Create 9 tiles (3x3)
        for (let i = 0; i < 9; i++) {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.setAttribute("data-tile-index", i);
          const questionTile = tileQuestions.find((q) => q.tileIndex === i);

          // Check if tile was already revealed
          if (isTileRevealed(i)) {
            tile.classList.add("revealed");
          }

          // First tile is Game 1 (Wordle)
          if (i === 3) {
            tile.textContent = "Game 1";
            tile.onclick = () => openWordleModal();
          } else if (i === 4) {
            // Second tile is Game 2 (Emoji)
            tile.textContent = "Game 2";
            tile.onclick = () => openEmojiModal();
          } else if (i === 5) {
            // Second tile is Game 2 (Emoji)
            tile.textContent = "Game 3";
            tile.onclick = () => openRebusModal();
          } else if (questionTile) {
            tile.textContent = questionTile.title;
            tile.onclick = () => {
              // Check if previous checkpoint is required and completed
              if (questionTile.requiresPrevious !== null) {
                if (!isTileRevealed(questionTile.requiresPrevious)) {
                  const requiredTitle = tileQuestions.find(
                    (q) => q.tileIndex === questionTile.requiresPrevious
                  ).title;

                  showNotice(`Please complete '${requiredTitle}' to continue.`);
                  return;
                }
              }
              openQAModal(questionTile);
            };
          } else {
            // Other tiles just reveal on click for now
            tile.onclick = () => revealTile(tile);
          }

          grid.appendChild(tile);
        }

        // Initialize Wordle board and keyboard
        initWordleBoard();
        initKeyboard();

        // Listen for physical keyboard
        document.addEventListener("keydown", handleKeyPress);

        // Check if background should be visible and if all tiles are revealed on load
        checkAndShowBackground();
        checkAllRevealed();
      };

      function revealTile(tile) {
        tile.classList.add("revealed");
        saveGameState();
        checkAndShowBackground();
        checkAllRevealed();
      }

      function checkAndShowBackground() {
        const tiles = document.querySelectorAll(".tile");
        const anyRevealed = Array.from(tiles).some((tile) =>
          tile.classList.contains("revealed")
        );

        if (anyRevealed) {
          document.querySelector(".background-image").classList.add("visible");
        }
      }

      function checkAllRevealed() {
        const tiles = document.querySelectorAll(".tile");
        const allRevealed = Array.from(tiles).every((tile) =>
          tile.classList.contains("revealed")
        );

        if (allRevealed) {
          document.getElementById("final-reveal").style.display = "block";
        }
      }

      function showNotice(message) {
        const modal = document.getElementById("notice-modal");
        const msgEl = document.getElementById("notice-message");
        msgEl.textContent = message;
        modal.classList.add("active");
      }

      function closeNoticeModal() {
        document.getElementById("notice-modal").classList.remove("active");
      }
    </script>
    <script src="./games/wordle.js"></script>
    <script src="./games/emoji.js"></script>
    <script src="./games/rebus.js"></script>
    <script src="./games/qa.js"></script>
  </body>
</html>